doctype html
html
  head
    meta(charset="utf-8")
    title 美女 Lu lu
    link(rel="stylesheet", href="http://g.tbcdn.cn/thx/cube/1.2.1/neat-min.css")
    link(rel="stylesheet", href="../css/base.css")
    link(rel="stylesheet", href="../css/fonts.css")
    link(rel="stylesheet", href="../css/screen.css")
    script(type="text/javascript", src="../js/socket.io.min.js")
    script(type="text/javascript", src="../js/qrcode.min.js")
  body
    main
      h1(class="title") 一起撸一撸
      div(class="game-box")
        div.start-box
          canvas(id="qrcode")
          input(id="btn", class="btn-start" type="button", value="开始游戏")
        div(id="J_game_canvas" class="game-canvas")
            .lulu
                .icon-body
                .icon-eye
                .icon-eye2
                .icon-nose
                .icon-hotdog
                <!-- 头发 -->
                .icon-hair
                <!-- 内衣 -->
                .icon-underwear
                <!-- 上衣 -->
                .icon-clothes
                <!-- 裤子 -->
                .icon-pants
        .progress-box
          div(class="progress-value") 100%
          .progress-bar
            progress(id="progress" value="200" max="200")
        div.start-box
    .dialog.over
        h3 GAME OVER
        .error
           p 服务器出现了一个故障!
           <button class="btn">谁撸的最快？</button>
        .rank
           ol(class="rank-list")
              li 
                span 撸手王子：桑老师
              li 
                span 最快撸手：苍老师  
    script.
      var qrcodedraw = new QRCodeLib.QRCodeDraw();
      var qrcode = document.querySelector('#qrcode');
      var progress = document.querySelector('#progress');
      var progress_val = document.querySelector('.progress-value');
      var underwear = document.querySelector('.icon-underwear');
      var clothes = document.querySelector('.icon-clothes');
      var pants = document.querySelector('.icon-pants');
      var clothesStep = 1, pantsStep = 1, underwearStep = 1;
      var ip = '#{ip}';
      var port = '#{port}';
      var game = ['http://', ip, ':', port, '/mobile'].join('');
      var socket;

      qrcodedraw.draw(qrcode, game, function(err, canvas){
        if(err){
          console.log(err.message);
        } else {
          socket = io.connect(['http://', ip, ':', port].join(''));
          socket.on('connection', function (data) {
            console.log('connected');
            socket.emit('screen');
          });
          socket.on('click', function(data){
            progress.value = --progress.value;
            progress_val.innerHTML = Math.ceil(progress.value / 2) + '%';

            var delta;
            if (clothesStep !== 0) {
              if (clothesStep < 0.015) {
                delta = 0.015 - clothesStep;
                clothesStep = 0;
                pantsStep -= delta;
                clothes.style.opacity = '0';
                pants.style.opacity = pantsStep + '';
              } else {
                clothesStep -= 0.015;
                clothes.style.opacity = clothesStep + '';
              }
            }

            if (clothesStep == 0 && pantsStep !== 0) {
              if (pantsStep < 0.015 ) {
                delta = 0.015 - pantsStep;
                pantsStep = 0;
                underwearStep -= delta;
                pants.style.opacity = '0';
                underwear.style.opacity = underwearStep + '';
              } else {
                pantsStep -= 0.015;
                pants.style.opacity = pantsStep + '';
              }
            }

            if (pantsStep == 0 && underwearStep !== 0) {
              if (underwearStep < 0.015) {
                underwear.style.opacity = '0';
                underwearStep = 0;
              } else if (underwearStep > 0){
                underwearStep -= 0.015;
                underwear.style.opacity = underwearStep + '';
              }
            }
          })
        }
      });

      var btn = document.getElementById('btn');
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        socket.emit('game start');
      }, false);
